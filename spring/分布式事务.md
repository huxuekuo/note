# 分布式事务



## CAP理论

> - Consistency(一致性)
> - Availability(可用性)
> - Partition tolerance(分区容错性)
>
> `一个分布式系统无法同时满足这3个指标`



### Partition tolerance(分区容错性)



大多数分布式系统,分布在多个子网中,每一个子网都叫做一个区,分区容错的意思是,区间通信可能失败, , 比如 A 服务 调用 B 服务, B 服务收不到调用, 一般来说, 分布式系统,分区容错无法避免, 因此CAP中, P 总是要保证的, 在 CA之间做取舍



### Consistency(一致性)



>  场景: 每个服务有一个`number`字段来记录接口调用次数



![image text](https://raw.githubusercontent.com/huxuekuo/note/master/images/CAP_C_ADD.jpg)

这是`用户服务A`的`number` 是 1 而 `服务B`的`number` 还是`0`, 在用户获取`用户服务A`的number与`服务B`的number不一致, 就不满足一致性, 只有每次更改是进行服务间同步保证





### Availability(可用性)







## SOA分布式事务解决方案



### 基于XA协议的两段提交的方案



备注: `事务的发起者称协调者，事务的执行者称参与者。`



交易中间件与数据库通过XA接口规范, 使用两阶段提交来完成一个全局事务,XA规范的基础是两阶段提交协议,



第一阶段是表决阶段, 所有参与者都将本事务能否成功的信息反馈给协调者



第二阶段是执行阶段,协调者根据所有参与者的反馈, 通知所有参与者, 步调一致的在所有分支上进行提交或者回滚,



两阶段提交方案非常广泛, 几乎所有商业OLTP数据库都支持XA协议, 但是两阶段提交方案锁定资源时间对性能影响很大,基本不适合解决微服务事务问题



## TCC 方案



TCC方案在电商,金融领域落地较多, TCC 方案其实就是两段提交的一种改进, 其整个业务逻辑的每个分支显示的分成了Try , Confirm , Cancel 三个操作, Try 部分完成业务的准备工作, confirm 部分完成业务的提交, cancel 部门完成事务的回滚,



